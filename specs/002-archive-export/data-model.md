# Data Model: Archive Export

**Feature**: 002-archive-export
**Date**: 2025-10-30

## Overview

This feature introduces 3 new model types to support export functionality. All models are designed to be lightweight and leverage existing `models.Post` structure.

## Core Entities

### 1. ExportOptions

**Purpose**: User-configurable options for export operations

**Location**: `internal/models/export.go`

**Structure**:
```go
type ExportOptions struct {
    // Format specifies output format: "json" or "csv"
    Format ExportFormat
    
    // OutputDir is the base directory for exports (default: "./exports")
    OutputDir string
    
    // IncludeMedia determines if media files should be copied
    IncludeMedia bool
    
    // DateRange filters posts by creation date (nil = all posts)
    DateRange *DateRange
    
    // DID specifies which user's posts to export (required)
    DID string
}

type ExportFormat string

const (
    ExportFormatJSON ExportFormat = "json"
    ExportFormatCSV  ExportFormat = "csv"
)

type DateRange struct {
    StartDate time.Time
    EndDate   time.Time
}
```

**Validation Rules**:
- Format must be "json" or "csv"
- DID must not be empty
- If DateRange provided, EndDate must be after StartDate
- OutputDir must be writable

**Relationships**:
- Used by ExportJob to configure export behavior
- Passed to exporter functions

---

### 2. ExportJob

**Purpose**: Tracks an in-progress or completed export operation

**Location**: `internal/models/export.go`

**Structure**:
```go
type ExportJob struct {
    // ID uniquely identifies this export (timestamp-based)
    ID string
    
    // Options used for this export
    Options ExportOptions
    
    // Progress tracks current state
    Progress ExportProgress
    
    // ExportDir is the full path to this export's output directory
    ExportDir string
    
    // CreatedAt is when export was initiated
    CreatedAt time.Time
    
    // CompletedAt is when export finished (nil if still running)
    CompletedAt *time.Time
}

type ExportProgress struct {
    PostsProcessed int
    PostsTotal     int
    MediaCopied    int
    MediaTotal     int
    Status         ExportStatus
    Error          string // Empty if no error
}

type ExportStatus string

const (
    ExportStatusQueued    ExportStatus = "queued"
    ExportStatusRunning   ExportStatus = "running"
    ExportStatusCompleted ExportStatus = "completed"
    ExportStatusFailed    ExportStatus = "failed"
)
```

**State Transitions**:
```
queued → running → completed
             ↓
           failed
```

**Relationships**:
- Created when user initiates export
- Updated during export progress
- Generates ExportManifest on completion

---

### 3. ExportManifest

**Purpose**: Metadata file describing export contents

**Location**: `internal/models/export.go`

**Structure**:
```go
type ExportManifest struct {
    // ExportFormat is "json" or "csv"
    ExportFormat string `json:"export_format"`
    
    // ExportTimestamp is when export was created
    ExportTimestamp time.Time `json:"export_timestamp"`
    
    // PostCount is number of posts in export
    PostCount int `json:"post_count"`
    
    // MediaCount is number of media files copied
    MediaCount int `json:"media_count"`
    
    // DateRange describes filtered time period (null if no filter)
    DateRange *DateRange `json:"date_range,omitempty"`
    
    // Version is the bskyarchive version that created export
    Version string `json:"version"`
    
    // Files lists output files in export directory
    Files []string `json:"files"`
}
```

**Serialization**:
- Written as `manifest.json` in export directory
- Pretty-printed JSON (2-space indent)
- UTF-8 encoding

**Relationships**:
- Generated by ExportJob on successful completion
- Used for export verification and documentation

---

## Existing Models (Reused)

### models.Post

**No changes required** - existing Post model already has all needed fields and JSON struct tags:
- URI, CID, DID (identifiers)
- Text, CreatedAt, IndexedAt (content and timestamps)
- LikeCount, RepostCount, ReplyCount, QuoteCount (engagement)
- IsReply, ReplyParent (threading)
- EmbedType, EmbedData, Labels (metadata)
- HasMedia (media presence indicator)

Used directly in JSON exports. Mapped to flat structure for CSV exports.

### models.Media

**No changes required** - existing Media model tracks media files:
- SHA256 (content hash - used as filename)
- MimeType, Width, Height (image metadata)
- PostURI (links media to post)

Used to find and copy media files during export.

---

## File System Structure

### Export Directory Layout

```
exports/
└── 2025-10-30_14-30-45/          # Timestamped export directory
    ├── manifest.json              # Export metadata
    ├── posts.json                 # JSON format (OR posts.csv for CSV)
    └── media/                     # Copied media files
        ├── abc123def456...jpg     # SHA-256 hash-based filenames
        ├── 789ghijkl012...png
        └── ...
```

**Naming Convention**:
- Export directory: `YYYY-MM-DD_HH-MM-SS` (sortable, filesystem-safe)
- Data file: `posts.json` or `posts.csv`
- Manifest: `manifest.json`
- Media directory: `media/`
- Media files: `{SHA256}.{ext}` (preserves original hash-based naming)

---

## CSV Schema

**CSV File Structure** (`posts.csv`):

| Column | Type | Description |
|--------|------|-------------|
| uri | string | AT Protocol URI |
| cid | string | Content ID |
| did | string | Decentralized ID of author |
| text | string | Post text content |
| created_at | ISO8601 | When post was created |
| indexed_at | ISO8601 | When post was indexed |
| like_count | integer | Number of likes |
| repost_count | integer | Number of reposts |
| reply_count | integer | Number of replies |
| quote_count | integer | Number of quote posts |
| is_reply | boolean | true/false |
| reply_parent | string | Parent post URI (empty if not reply) |
| has_media | boolean | true/false |
| media_files | string | Semicolon-separated list of media filenames |
| embed_type | string | Type of embed (images/external/record) |

**Encoding**: UTF-8 with BOM (Excel compatibility)
**Escaping**: RFC 4180 (quotes, commas, newlines handled by encoding/csv)

---

## JSON Schema

**JSON File Structure** (`posts.json`):

```json
[
  {
    "uri": "at://did:plc:xxx/app.bsky.feed.post/yyy",
    "cid": "bafyxxx",
    "did": "did:plc:xxx",
    "text": "Post content here",
    "created_at": "2025-10-30T14:30:45Z",
    "indexed_at": "2025-10-30T14:31:00Z",
    "has_media": true,
    "like_count": 42,
    "repost_count": 7,
    "reply_count": 3,
    "quote_count": 1,
    "is_reply": false,
    "reply_parent": "",
    "embed_type": "images",
    "embed_data": { ... },
    "labels": [],
    "archived_at": "2025-10-30T14:31:00Z"
  }
]
```

**Encoding**: UTF-8, pretty-printed (2-space indent)
**Structure**: Array of Post objects (matches existing `models.Post` JSON tags)

---

## Summary

**New Models**: 3 (ExportOptions, ExportJob, ExportManifest)
**Modified Models**: 0 (reuses existing Post and Media)
**New Files**: 1 (`internal/models/export.go`)
**Database Changes**: None (export metadata not persisted - in-memory only)
