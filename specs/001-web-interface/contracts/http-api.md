# HTTP API Contracts: Web Interface

**Feature**: Web Interface (001-web-interface)
**Date**: 2025-10-30
**Status**: Complete

## Overview

This document defines all HTTP routes, request/response formats, and behaviors for the web interface. The API follows a server-rendered HTML approach with HTMX for dynamic interactions.

## Base URL

```
http://localhost:8080
```

(Port configurable via config file)

## Authentication

- **Session-based**: Uses encrypted HTTP-only cookies
- **Session Duration**: 7 days with rolling expiration
- **CSRF Protection**: All POST/PUT/DELETE requests require CSRF token

### Session Cookie

```
Name: bsky_session
Attributes:
- HttpOnly: true
- Secure: false (localhost only)
- SameSite: Lax
- MaxAge: 604800 (7 days)
- Path: /
```

### CSRF Token

Included in two ways:
1. **Forms**: Hidden input field generated by template
2. **HTMX**: Meta tag + JavaScript header injection

```html
<meta name="csrf-token" content="{{.CSRFToken}}">
```

## Routes

### Public Routes (No Authentication Required)

#### GET /

**Description**: Landing page - shows login button for unauthenticated users

**Response**: HTML page

**Status Codes**:
- `200 OK`: Landing page rendered
- `302 Found`: Redirect to `/dashboard` if already authenticated

**Response Headers**:
```
Content-Type: text/html; charset=utf-8
Cache-Control: no-cache
```

**Example**:
```html
<!DOCTYPE html>
<html>
  <head>
    <title>Bluesky Personal Archive</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>
    <main class="container">
      <h1>Bluesky Personal Archive</h1>
      <p>Preserve your Bluesky posts, interactions, and profile data locally.</p>
      <form action="/auth/login" method="POST">
        <input type="hidden" name="csrf_token" value="...">
        <button type="submit">Login with Bluesky</button>
      </form>
    </main>
  </body>
</html>
```

---

#### GET /about

**Description**: About page with project info and links

**Response**: HTML page

**Status Codes**:
- `200 OK`: About page rendered

**Response Headers**:
```
Content-Type: text/html; charset=utf-8
Cache-Control: no-cache
```

**Example**:
```html
<!DOCTYPE html>
<html>
  <head>
    <title>About - Bluesky Personal Archive</title>
  </head>
  <body>
    <main class="container">
      <h1>About</h1>
      <p>Version: {{.Version}}</p>
      <p>GitHub: <a href="{{.GitHubURL}}" target="_blank">{{.GitHubURL}}</a></p>
      <p>Author: <a href="{{.BlueskyURL}}" target="_blank">{{.BlueskyHandle}}</a></p>
    </main>
  </body>
</html>
```

---

### Authentication Routes

#### POST /auth/login

**Description**: Initiates OAuth flow with Bluesky

**Request**:
```
Content-Type: application/x-www-form-urlencoded

csrf_token=abc123
```

**Response**: HTTP redirect

**Status Codes**:
- `302 Found`: Redirect to Bluesky OAuth authorization page
- `403 Forbidden`: Invalid CSRF token
- `500 Internal Server Error`: OAuth initialization failed

**Response Headers**:
```
Location: https://bsky.social/oauth/authorize?client_id=...
Set-Cookie: oauth_state=random_state; HttpOnly; Secure; SameSite=Lax; Max-Age=600
```

---

#### GET /auth/callback

**Description**: OAuth callback endpoint - receives auth code from Bluesky

**Request Query Parameters**:
- `code` (string, required): OAuth authorization code
- `state` (string, required): CSRF state parameter

**Response**: HTTP redirect

**Status Codes**:
- `302 Found`: Redirect to `/dashboard` on success
- `302 Found`: Redirect to `/?error=oauth_denied` if user denied authorization
- `302 Found`: Redirect to `/?error=oauth_failed` if token exchange failed
- `400 Bad Request`: Missing or invalid parameters
- `403 Forbidden`: State mismatch (CSRF protection)

**Response Headers (Success)**:
```
Location: /dashboard
Set-Cookie: bsky_session=encrypted_data; HttpOnly; Secure; SameSite=Lax; Max-Age=604800
```

**Error Redirect Examples**:
```
Location: /?error=oauth_denied&message=User%20denied%20authorization
Location: /?error=oauth_failed&message=Failed%20to%20exchange%20auth%20code
```

---

#### POST /auth/logout

**Description**: Destroys user session and logs out

**Request**:
```
Content-Type: application/x-www-form-urlencoded

csrf_token=abc123
```

**Response**: HTTP redirect

**Status Codes**:
- `302 Found`: Redirect to `/` after logout
- `403 Forbidden`: Invalid CSRF token

**Response Headers**:
```
Location: /
Set-Cookie: bsky_session=; Max-Age=0; Path=/
```

---

### Protected Routes (Authentication Required)

All protected routes check for valid session. If missing or expired:
- **Status**: `302 Found`
- **Location**: `/?error=session_expired&message=Please%20log%20in%20again`

#### GET /dashboard

**Description**: User dashboard with archive overview

**Response**: HTML page

**Status Codes**:
- `200 OK`: Dashboard rendered
- `302 Found`: Redirect to `/` if not authenticated

**Response Headers**:
```
Content-Type: text/html; charset=utf-8
Cache-Control: no-cache
```

**Response Body** (HTML with embedded data):
```html
<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard - Bluesky Archive</title>
    <script src="/static/js/htmx.min.js"></script>
  </head>
  <body>
    <main class="container">
      <h1>Welcome, {{.User.DisplayName}}</h1>
      <section class="archive-stats">
        <h2>Archive Status</h2>
        <p>Total Posts: {{.ArchiveStatus.TotalPosts}}</p>
        <p>Total Media: {{.ArchiveStatus.TotalMedia}}</p>
        <p>Last Sync: {{.ArchiveStatus.LastSyncTime | formatTime}}</p>
      </section>
      {{if .ArchiveStatus.CurrentOperation}}
        <section hx-get="/api/progress/{{.ArchiveStatus.CurrentOperation.OperationID}}"
                 hx-trigger="every 2s"
                 hx-swap="innerHTML">
          <!-- Progress bar updated via HTMX -->
        </section>
      {{end}}
      <section class="recent-posts">
        <h2>Recent Posts</h2>
        <!-- List of recent posts -->
      </section>
    </main>
  </body>
</html>
```

---

#### GET /archive

**Description**: Archive management page - initiate syncs, view status

**Response**: HTML page

**Status Codes**:
- `200 OK`: Archive page rendered
- `302 Found`: Redirect to `/` if not authenticated

**Response Headers**:
```
Content-Type: text/html; charset=utf-8
Cache-Control: no-cache
```

**Response Body** (HTML):
```html
<!DOCTYPE html>
<html>
  <body>
    <main class="container">
      <h1>Archive Management</h1>
      <section class="archive-status">
        <p>Total Posts: {{.ArchiveStatus.TotalPosts}}</p>
        <p>Last Sync: {{.ArchiveStatus.LastSyncTime | formatTime}}</p>
      </section>

      {{if .CanStartSync}}
        <section class="sync-controls">
          <form hx-post="/api/archive/sync" hx-swap="outerHTML">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <label>
              <input type="radio" name="sync_type" value="incremental" checked>
              Incremental (fetch only new posts)
            </label>
            <label>
              <input type="radio" name="sync_type" value="full">
              Full (re-sync entire archive)
            </label>
            <button type="submit">Start Sync</button>
          </form>
        </section>
      {{else}}
        <section class="operation-progress"
                 hx-get="/api/progress/{{.ArchiveStatus.CurrentOperation.OperationID}}"
                 hx-trigger="every 2s"
                 hx-swap="innerHTML">
          <!-- Progress updates -->
        </section>
      {{end}}
    </main>
  </body>
</html>
```

---

#### GET /browse

**Description**: Browse archived posts with pagination

**Query Parameters**:
- `page` (integer, optional, default=1): Page number
- `size` (integer, optional, default=50): Posts per page

**Response**: HTML page

**Status Codes**:
- `200 OK`: Browse page rendered
- `302 Found`: Redirect to `/` if not authenticated
- `400 Bad Request`: Invalid page or size parameters

**Response Headers**:
```
Content-Type: text/html; charset=utf-8
Cache-Control: no-cache
```

**Response Body** (HTML):
```html
<!DOCTYPE html>
<html>
  <body>
    <main class="container">
      <h1>Archived Posts</h1>
      <section id="posts-list">
        {{range .PostPage.Posts}}
          <article class="post-card">
            <header>
              <strong>{{.AuthorDisplayName}}</strong>
              <small>@{{.AuthorHandle}}</small>
              <time>{{.CreatedAt | formatTime}}</time>
            </header>
            <p>{{.Text}}</p>
            <footer>
              <span>‚ù§Ô∏è {{.LikeCount}}</span>
              <span>üîÅ {{.RepostCount}}</span>
              <span>üí¨ {{.ReplyCount}}</span>
            </footer>
          </article>
        {{end}}
      </section>

      <nav class="pagination">
        {{if .PostPage.HasPrevious}}
          <a href="/browse?page={{sub .PostPage.CurrentPage 1}}&size={{.PostPage.PageSize}}"
             hx-get="/browse?page={{sub .PostPage.CurrentPage 1}}&size={{.PostPage.PageSize}}"
             hx-target="#posts-list"
             hx-swap="outerHTML">
            Previous
          </a>
        {{end}}
        <span>Page {{.PostPage.CurrentPage}} of {{.PostPage.TotalPages}}</span>
        {{if .PostPage.HasNext}}
          <a href="/browse?page={{add .PostPage.CurrentPage 1}}&size={{.PostPage.PageSize}}"
             hx-get="/browse?page={{add .PostPage.CurrentPage 1}}&size={{.PostPage.PageSize}}"
             hx-target="#posts-list"
             hx-swap="outerHTML">
            Next
          </a>
        {{end}}
      </nav>
    </main>
  </body>
</html>
```

---

### API Endpoints (HTMX/AJAX)

These endpoints return HTML fragments for HTMX consumption.

#### POST /api/archive/sync

**Description**: Initiates archive sync operation

**Request**:
```
Content-Type: application/x-www-form-urlencoded

csrf_token=abc123&sync_type=incremental
```

**Request Parameters**:
- `csrf_token` (string, required): CSRF token
- `sync_type` (string, required): "incremental" or "full"

**Response**: HTML fragment

**Status Codes**:
- `200 OK`: Sync initiated successfully, returns progress HTML
- `400 Bad Request`: Invalid sync_type
- `403 Forbidden`: Invalid CSRF token
- `409 Conflict`: Operation already in progress
- `500 Internal Server Error`: Failed to start sync

**Response Body (Success)**:
```html
<section class="operation-progress"
         hx-get="/api/progress/op_12345"
         hx-trigger="every 2s"
         hx-swap="innerHTML">
  <h3>Sync In Progress</h3>
  <progress value="0" max="100">0%</progress>
  <p>Starting sync...</p>
</section>
```

**Response Body (Error - 409 Conflict)**:
```html
<section class="error">
  <p class="error-message">An archive operation is already in progress. Please wait for it to complete.</p>
</section>
```

---

#### GET /api/progress/:operationID

**Description**: Get real-time progress of an archive operation

**URL Parameters**:
- `operationID` (string, required): Operation identifier

**Response**: HTML fragment

**Status Codes**:
- `200 OK`: Progress info returned
- `404 Not Found`: Operation not found
- `302 Found`: Redirect to `/` if not authenticated

**Response Headers**:
```
Content-Type: text/html; charset=utf-8
Cache-Control: no-store
```

**Response Body (In Progress)**:
```html
<h3>Sync In Progress</h3>
<progress value="45.5" max="100">45.5%</progress>
<p>Fetched 1234 posts, downloaded 567 media files...</p>
<small>Started: 2 minutes ago</small>
```

**Response Body (Completed)**:
```html
<h3>Sync Complete! ‚úÖ</h3>
<p>Successfully archived 1500 posts and 650 media files.</p>
<p>Archive updated at {{now | formatTime}}</p>
<a href="/archive" class="button">Start Another Sync</a>
```

**Response Body (Failed)**:
```html
<h3>Sync Failed ‚ùå</h3>
<p class="error-message">{{.ErrorMessage}}</p>
<details>
  <summary>Error Details</summary>
  <pre>{{.DetailedError}}</pre>
</details>
<a href="/archive" class="button">Try Again</a>
```

---

#### POST /api/archive/cancel/:operationID

**Description**: Cancel an in-progress archive operation

**URL Parameters**:
- `operationID` (string, required): Operation identifier

**Request**:
```
Content-Type: application/x-www-form-urlencoded

csrf_token=abc123
```

**Response**: HTML fragment

**Status Codes**:
- `200 OK`: Operation cancelled successfully
- `400 Bad Request`: Operation not cancellable (already completed/failed)
- `403 Forbidden`: Invalid CSRF token
- `404 Not Found`: Operation not found

**Response Body (Success)**:
```html
<section class="info">
  <p>Archive operation cancelled.</p>
  <a href="/archive" class="button">Go to Archive Management</a>
</section>
```

---

### Static Assets

#### GET /static/*

**Description**: Serves static CSS, JS, and image files

**Response**: File content with appropriate MIME type

**Status Codes**:
- `200 OK`: File found and served
- `404 Not Found`: File does not exist

**Response Headers**:
```
Content-Type: <detected MIME type>
Cache-Control: public, max-age=31536000  # for versioned assets
# or
Cache-Control: no-cache  # for un-versioned assets
```

**Examples**:
```
/static/css/pico.min.css
/static/css/styles.css
/static/js/htmx.min.js
/static/js/app.js
/static/images/logo.png
```

---

## Error Responses

### HTML Error Pages

For browser requests, errors return full HTML error pages.

**404 Not Found**:
```html
<!DOCTYPE html>
<html>
  <head>
    <title>404 - Page Not Found</title>
  </head>
  <body>
    <main class="container">
      <h1>404 - Page Not Found</h1>
      <p>The page you're looking for doesn't exist.</p>
      <a href="/">Go to Homepage</a>
    </main>
  </body>
</html>
```

**500 Internal Server Error**:
```html
<!DOCTYPE html>
<html>
  <head>
    <title>500 - Server Error</title>
  </head>
  <body>
    <main class="container">
      <h1>500 - Something Went Wrong</h1>
      <p>We're sorry, but something went wrong on our end.</p>
      <p>Please try again later or contact support if the problem persists.</p>
      <a href="/">Go to Homepage</a>
    </main>
  </body>
</html>
```

### HTMX Error Fragments

For HTMX requests (detected via `HX-Request` header), errors return HTML fragments.

**Example Error Fragment**:
```html
<div class="error-message">
  <strong>Error:</strong> {{.Message}}
</div>
```

---

## HTMX Headers

### Request Headers

HTMX sends these headers with AJAX requests:

```
HX-Request: true
HX-Current-URL: http://localhost:8080/browse?page=2
HX-Target: posts-list
HX-Trigger: user-action
X-CSRF-Token: abc123
```

### Response Headers

Server can use HTMX response headers for client-side actions:

```
HX-Trigger: refresh-dashboard   # Trigger custom event on client
HX-Redirect: /dashboard         # Client-side redirect
HX-Refresh: true                # Refresh entire page
```

---

## Security Considerations

### CSRF Protection

- All POST/PUT/DELETE requests require valid CSRF token
- Token validated by middleware before handler execution
- 403 Forbidden returned for missing/invalid tokens

### Session Security

- Sessions stored in encrypted cookies (gorilla/sessions)
- HTTP-only cookies (JavaScript cannot access)
- SameSite=Lax (CSRF protection)
- 7-day expiration with rolling window
- Session regenerated on authentication

### Rate Limiting

(Future enhancement - not in MVP scope)

- Limit sync initiation: 1 per 5 minutes per user
- Limit page requests: 100 per minute per IP

---

## Request/Response Examples

### Example 1: Complete OAuth Flow

**Step 1: User clicks login**
```
POST /auth/login HTTP/1.1
Host: localhost:8080
Content-Type: application/x-www-form-urlencoded

csrf_token=abc123

‚Üí Response:
HTTP/1.1 302 Found
Location: https://bsky.social/oauth/authorize?client_id=...&redirect_uri=...&state=xyz789
Set-Cookie: oauth_state=xyz789; HttpOnly; Max-Age=600
```

**Step 2: User authorizes on Bluesky**

**Step 3: Bluesky redirects back**
```
GET /auth/callback?code=auth_code_123&state=xyz789 HTTP/1.1
Host: localhost:8080
Cookie: oauth_state=xyz789

‚Üí Response:
HTTP/1.1 302 Found
Location: /dashboard
Set-Cookie: bsky_session=encrypted_session_data; HttpOnly; Max-Age=604800
Set-Cookie: oauth_state=; Max-Age=0
```

### Example 2: Start Incremental Sync with HTMX

**Request**:
```
POST /api/archive/sync HTTP/1.1
Host: localhost:8080
Content-Type: application/x-www-form-urlencoded
HX-Request: true
X-CSRF-Token: abc123
Cookie: bsky_session=...

sync_type=incremental&csrf_token=abc123

‚Üí Response:
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8

<section class="operation-progress"
         hx-get="/api/progress/op_12345"
         hx-trigger="every 2s"
         hx-swap="innerHTML">
  <h3>Sync In Progress</h3>
  <progress value="0" max="100">0%</progress>
  <p>Starting sync...</p>
</section>
```

### Example 3: Poll Progress

**Request**:
```
GET /api/progress/op_12345 HTTP/1.1
Host: localhost:8080
HX-Request: true
Cookie: bsky_session=...

‚Üí Response:
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Cache-Control: no-store

<h3>Sync In Progress</h3>
<progress value="67.3" max="100">67.3%</progress>
<p>Fetched 2010 posts, downloaded 980 media files...</p>
<small>Started: 5 minutes ago</small>
```

---

## Summary

All HTTP routes defined:
- **Public**: `/`, `/about`
- **Auth**: `/auth/login`, `/auth/callback`, `/auth/logout`
- **Protected**: `/dashboard`, `/archive`, `/browse`
- **API**: `/api/archive/sync`, `/api/progress/:id`, `/api/archive/cancel/:id`
- **Static**: `/static/*`

All routes follow:
- Server-rendered HTML with HTMX for dynamic updates
- Session-based authentication with 7-day expiration
- CSRF protection on all state-changing operations
- Clear error handling with user-friendly messages
- Responsive HTML that works without JavaScript (progressive enhancement)

Ready to proceed to quickstart.md.
