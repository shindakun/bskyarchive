{{define "title"}}Export Archive - Bluesky Archive{{end}}

{{define "nav"}}
<nav class="container">
    <ul>
        <li><strong>Bluesky Archive</strong></li>
    </ul>
    <ul>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/archive">Archive</a></li>
        <li><a href="/browse">Browse</a></li>
        <li><a href="/export">Export</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/auth/logout">Logout</a></li>
    </ul>
</nav>
{{end}}

{{define "content"}}
<section>
    <hgroup>
        <h1>Export Archive</h1>
        <h2>Export your archived posts to JSON or CSV format</h2>
    </hgroup>

    {{if .Error}}
    <article aria-label="Error">
        <header><strong>Error</strong></header>
        <p>{{.Error}}</p>
    </article>
    {{end}}

    {{if .Message}}
    <article aria-label="Success">
        <header><strong>Success</strong></header>
        <p>{{.Message}}</p>
    </article>
    {{end}}

    <!-- Export Form -->
    <article>
        <header><strong>Export Options</strong></header>

        <!-- Dynamic error display for client-side validation errors -->
        <div id="export-error" style="display: none;">
            <article aria-label="Error" style="background-color: var(--del-color); border-left: 4px solid #dc3545;">
                <header><strong>Error</strong></header>
                <p id="export-error-message"></p>
            </article>
        </div>

        <form id="export-form" hx-post="/export/start" hx-swap="none" hx-on::after-request="handleExportStart(event)">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <!-- Format Selection -->
            <fieldset>
                <legend>Export Format</legend>
                <label>
                    <input type="radio" name="format" value="json" checked>
                    JSON - Complete metadata with nested structures
                </label>
                <label>
                    <input type="radio" name="format" value="csv">
                    CSV - Spreadsheet-compatible format for Excel and Google Sheets
                </label>
            </fieldset>

            <!-- Media Options -->
            <fieldset>
                <legend>Media Files</legend>
                <label>
                    <input type="checkbox" name="include_media" value="true" checked>
                    Include media files in export
                </label>
                <small>Media files will be copied to a /media subdirectory</small>
            </fieldset>

            <!-- Date Range Filtering (Optional) -->
            <fieldset>
                <legend>Date Range (Optional)</legend>
                <label>
                    Start Date
                    <input type="date" name="start_date" placeholder="YYYY-MM-DD">
                </label>
                <label>
                    End Date
                    <input type="date" name="end_date" placeholder="YYYY-MM-DD">
                </label>
                <small>Leave blank to export all posts. Only posts within the date range will be exported.</small>
            </fieldset>

            <button type="submit">Start Export</button>
        </form>
    </article>

    <!-- Progress Display (initially hidden) -->
    <article id="export-progress" style="display: none;">
        <header><strong>Export Progress</strong></header>
        <div id="progress-content">
            <p>Initializing export...</p>
            <progress value="0" max="100"></progress>
        </div>
    </article>

    <!-- Export History -->
    {{if .Status}}
    {{if gt .Status.TotalPosts 0}}
    <article>
        <header><strong>Export Information</strong></header>
        <dl>
            <dt>Total Posts Available</dt>
            <dd>{{.Status.TotalPosts}}</dd>
            <dt>Total Media Files</dt>
            <dd>{{.Status.TotalMedia}}</dd>
            <dt>Estimated Export Size</dt>
            <dd>~{{.Status.TotalMedia}} MB (with media)</dd>
        </dl>
        <small>Exports are saved to the <code>./exports/</code> directory with timestamp-based folder names</small>
    </article>
    {{end}}
    {{end}}

    <!-- Completed Exports List -->
    <article id="exports-section">
        <header><strong>Your Exports</strong></header>

        {{if .Exports}}
        <figure id="exports-table-container">
            <table role="grid">
                <thead>
                    <tr>
                        <th>Created</th>
                        <th>Format</th>
                        <th>Date Range</th>
                        <th>Posts</th>
                        <th>Media</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="exports-tbody">
                    {{range .Exports}}
                    <tr id="export-{{.ID}}">
                        <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                        <td>{{.Format}}</td>
                        <td>{{.DateRangeString}}</td>
                        <td>{{.PostCount}}</td>
                        <td>{{.MediaCount}}</td>
                        <td>{{.HumanSize}}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <a href="/export/download/{{.ID}}"
                                       role="button"
                                       class="secondary download-btn"
                                       style="margin: 0; flex: 1;"
                                       data-export-id="{{.ID}}">
                                        Download ZIP
                                    </a>
                                    <button type="button"
                                            class="outline delete-export-btn"
                                            style="margin: 0;"
                                            hx-delete="/export/delete/{{.ID}}"
                                            hx-confirm="Are you sure you want to delete this export? This action cannot be undone."
                                            hx-target="closest tr"
                                            hx-swap="delete"
                                            hx-headers='{"X-CSRF-Token": "{{$.CSRFToken}}"}'>
                                        Delete
                                    </button>
                                </div>
                                <label style="margin: 0; font-size: 0.875rem;">
                                    <input type="checkbox"
                                           class="delete-after-checkbox"
                                           data-export-id="{{.ID}}"
                                           style="margin-right: 0.25rem;">
                                    Delete after download
                                </label>
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </figure>

        <small>Click "Download ZIP" to download an export as a compressed archive. Click "Delete" to permanently remove an export from the server. Exports can be downloaded multiple times before deletion.</small>
        {{else}}
        <div id="no-exports-message">
            <p>No exports yet. Create your first export using the form above!</p>
        </div>
        {{end}}
    </article>
</section>

<script>
    let pollInterval = null;

    function handleExportStart(event) {
        // Hide any previous errors
        const errorDiv = document.getElementById('export-error');
        errorDiv.style.display = 'none';

        if (event.detail.successful) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                const jobID = response.job_id;
                const message = response.message || 'Export started successfully';

                // Show progress section
                const progressSection = document.getElementById('export-progress');
                const progressContent = document.getElementById('progress-content');
                progressSection.style.display = 'block';

                // Show initial message
                progressContent.innerHTML = `
                    <p><strong>${message}</strong></p>
                    <p>Preparing export...</p>
                    <progress value="0" max="100"></progress>
                `;

                // Disable form during export
                document.getElementById('export-form').querySelectorAll('input, button').forEach(el => el.disabled = true);

                // Start polling for progress
                startProgressPolling(jobID);
            } catch (e) {
                console.error('Failed to parse export response:', e);
                showError('Failed to parse server response. Please try again.');
            }
        } else {
            // Extract error message from response
            let errorMessage = 'Failed to start export. Please try again.';
            try {
                const responseText = event.detail.xhr.responseText;
                // The error is plain text from http.Error()
                if (responseText && responseText.trim() !== '') {
                    errorMessage = responseText.trim();
                }
            } catch (e) {
                console.error('Failed to parse error response:', e);
            }
            showError(errorMessage);
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('export-error');
        const errorMessage = document.getElementById('export-error-message');
        errorMessage.textContent = message;
        errorDiv.style.display = 'block';

        // Scroll to error message
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function startProgressPolling(jobID) {
        // Clear any existing interval
        if (pollInterval) {
            clearInterval(pollInterval);
        }

        // Poll every 2 seconds
        pollInterval = setInterval(() => {
            fetch('/export/progress/' + jobID, {
                headers: {
                    'HX-Request': 'true'
                }
            })
            .then(response => response.text())
            .then(html => {
                const progressContent = document.getElementById('progress-content');
                progressContent.innerHTML = html;

                // Check if export is complete or failed
                if (html.includes('Export completed successfully')) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    // Re-enable form
                    document.getElementById('export-form').querySelectorAll('input, button').forEach(el => el.disabled = false);

                    // Extract export ID from the response (it's in a data attribute)
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const exportIdElement = doc.querySelector('[data-export-id]');

                    if (exportIdElement) {
                        const exportID = exportIdElement.getAttribute('data-export-id');

                        // Fetch the new export row and prepend it to the table
                        fetch('/export/row/' + exportID, {
                            headers: {
                                'HX-Request': 'true'
                            }
                        })
                        .then(response => response.text())
                        .then(rowHtml => {
                            let tbody = document.getElementById('exports-tbody');

                            // Check if this is the first export (no table exists yet)
                            if (!tbody) {
                                // Remove "No exports yet" message
                                const noExportsMessage = document.getElementById('no-exports-message');
                                if (noExportsMessage) {
                                    noExportsMessage.remove();
                                }

                                // Create the table structure
                                const exportsSection = document.getElementById('exports-section');
                                const tableHtml = `
                                    <figure id="exports-table-container">
                                        <table role="grid">
                                            <thead>
                                                <tr>
                                                    <th>Created</th>
                                                    <th>Format</th>
                                                    <th>Date Range</th>
                                                    <th>Posts</th>
                                                    <th>Media</th>
                                                    <th>Size</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="exports-tbody"></tbody>
                                        </table>
                                    </figure>
                                    <small>Click "Download ZIP" to download an export as a compressed archive. Click "Delete" to permanently remove an export from the server. Exports can be downloaded multiple times before deletion.</small>
                                `;

                                // Insert table after the header
                                const header = exportsSection.querySelector('header');
                                header.insertAdjacentHTML('afterend', tableHtml);
                                tbody = document.getElementById('exports-tbody');
                            }

                            if (tbody) {
                                // Create a temporary element to parse the HTML
                                const temp = document.createElement('tbody');
                                temp.innerHTML = rowHtml;
                                const newRow = temp.firstElementChild;

                                // Prepend the new row (newest first)
                                tbody.insertBefore(newRow, tbody.firstChild);

                                // Re-attach event listeners for the new row
                                attachDownloadButtonListeners();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching new export row:', error);
                            // Fallback to page reload if fetch fails
                            window.location.reload();
                        });
                    } else {
                        // Fallback: reload page if we can't find the export ID
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else if (html.includes('Export failed')) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    // Re-enable form
                    document.getElementById('export-form').querySelectorAll('input, button').forEach(el => el.disabled = false);
                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
            });
        }, 2000);
    }

    // Function to attach event listeners to download buttons
    function attachDownloadButtonListeners() {
        // Remove old listener if it exists to avoid duplicates
        // (We'll use event delegation instead)
    }

    // Handle "Delete after download" checkbox (T046 & T047)
    // Using event delegation to handle dynamically added rows
    document.addEventListener('click', function(e) {
        // Check if a download button was clicked
        if (e.target.classList.contains('download-btn')) {
            const exportId = e.target.getAttribute('data-export-id');
            const checkbox = document.querySelector(`.delete-after-checkbox[data-export-id="${exportId}"]`);

            if (checkbox && checkbox.checked) {
                e.preventDefault();

                // Show confirmation dialog (T047 - user feedback)
                const confirmed = confirm(
                    'This will download the export and immediately delete it from the server. ' +
                    'This action cannot be undone. Continue?'
                );

                if (confirmed) {
                    // Show visual feedback
                    const originalText = e.target.textContent;
                    e.target.textContent = 'Downloading & Deleting...';
                    e.target.style.opacity = '0.6';

                    // Add delete_after=true to URL and trigger download
                    const url = e.target.href + '?delete_after=true';
                    window.location.href = url;

                    // Remove the row after a short delay (gives time for download to start)
                    setTimeout(() => {
                        const row = e.target.closest('tr');
                        if (row) {
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    }, 2000);
                }
            }
            // If checkbox is not checked, let the normal href navigation happen
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (pollInterval) {
            clearInterval(pollInterval);
        }
    });
</script>
{{end}}
